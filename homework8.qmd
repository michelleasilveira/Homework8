---
title: "Homework 8 - Seoul Bike Rentals â€” MLR with tidymodels (HW)"
format: html
editor: visual
---

```{r}
#| label: setup
set.seed(2025)
library(tidyverse); library(lubridate); library(janitor); library(skimr); library(GGally)
library(tidymodels)
```

# Data prep

```{r}
#| label: data
url <- "https://www4.stat.ncsu.edu/~online/datasets/SeoulBikeData.csv"
raw_hourly <- readr::read_csv(url, locale = readr::locale(encoding = "Latin1")) %>% clean_names()

hourly <- raw_hourly %>%
  mutate(
    date = dmy(date),
    seasons = factor(seasons, levels = c("Winter","Spring","Summer","Autumn")),
    holiday = factor(holiday),
    functioning_day = factor(functioning_day)
  ) %>%
  rename(
    bike_count      = rented_bike_count,
    temp            = temperature_c,
    humidity        = humidity_percent,
    windspeed       = wind_speed_m_s,
    visibility      = visibility_10m,
    dew_point_temp  = dew_point_temperature_c,
    solar_radiation = solar_radiation_mj_m2,
    rainfall        = rainfall_mm,
    snowfall        = snowfall_cm
  )

daily <- hourly %>% filter(functioning_day == "Yes") %>%
  group_by(date, seasons, holiday) %>%
  summarise(
    bike_count      = sum(bike_count, na.rm = TRUE),
    rainfall        = sum(rainfall, na.rm = TRUE),
    snowfall        = sum(snowfall, na.rm = TRUE),
    temp            = mean(temp, na.rm = TRUE),
    humidity        = mean(humidity, na.rm = TRUE),
    windspeed       = mean(windspeed, na.rm = TRUE),
    visibility      = mean(visibility, na.rm = TRUE),
    dew_point_temp  = mean(dew_point_temp, na.rm = TRUE),
    solar_radiation = mean(solar_radiation, na.rm = TRUE),
    .groups = "drop"
  )
```

# Split

```{r}
#| label: split
set.seed(2025)
split_obj <- initial_split(daily, prop = 0.75, strata = seasons)
train <- training(split_obj); test <- testing(split_obj)
set.seed(2025); cv10 <- vfold_cv(train, v = 10, strata = seasons)
```

# Recipes

```{r}
#| label: recipes
base_recipe <- function(dat) {
  recipe(bike_count ~ ., data = dat) %>%
    update_role(date, new_role = "ID") %>%
    step_date(date, features = "dow", label = TRUE) %>%
    step_mutate(is_weekend = as.integer(as.character(date_dow) %in% c("Saturday","Sunday"))) %>%
    step_rm(date_dow) %>%
    step_dummy(all_nominal_predictors(), one_hot = TRUE) %>%
    step_zv(all_predictors()) %>%
    step_normalize(all_numeric_predictors())
}

rec1 <- base_recipe(train)

rec2 <- base_recipe(train) %>%
  step_interact(terms = ~ starts_with("seasons_"):starts_with("holiday_") +
                      starts_with("seasons_"):temp +
                      temp:rainfall)

# Explicitly apply poly ONLY to continuous weather vars (avoid dummy/binary columns)
rec3 <- base_recipe(train) %>%
  step_interact(terms = ~ starts_with("seasons_"):starts_with("holiday_") +
                      starts_with("seasons_"):temp +
                      temp:rainfall) %>%
  step_poly(temp, humidity, windspeed, visibility, dew_point_temp, solar_radiation, rainfall, snowfall,
            degree = 2)
```

# Model + CV

```{r}
#| label: model-cv
lm_spec <- linear_reg() %>% set_engine("lm")
wf1 <- workflow() %>% add_model(lm_spec) %>% add_recipe(rec1)
wf2 <- workflow() %>% add_model(lm_spec) %>% add_recipe(rec2)
wf3 <- workflow() %>% add_model(lm_spec) %>% add_recipe(rec3)

metrics <- metric_set(rmse, rsq)
set.seed(2025)
res1 <- fit_resamples(wf1, resamples = cv10, metrics = metrics, control = control_resamples(save_pred = TRUE))
set.seed(2025)
res2 <- fit_resamples(wf2, resamples = cv10, metrics = metrics, control = control_resamples(save_pred = TRUE))
set.seed(2025)
res3 <- fit_resamples(wf3, resamples = cv10, metrics = metrics, control = control_resamples(save_pred = TRUE))

cv_summary <- bind_rows(
  collect_metrics(res1) %>% mutate(model = "Recipe 1"),
  collect_metrics(res2) %>% mutate(model = "Recipe 2"),
  collect_metrics(res3) %>% mutate(model = "Recipe 3")
) %>% filter(.metric == "rmse") %>% arrange(mean)

cv_summary
best_model_name <- cv_summary$model[1]
best_model_name
```

# Finalize

```{r}
#| label: finalize
best_wf <- switch(best_model_name, "Recipe 1" = wf1, "Recipe 2" = wf2, "Recipe 3" = wf3)
final_fit <- last_fit(best_wf, split = split_obj, metrics = metrics)
collect_metrics(final_fit)

final_model <- extract_fit_parsnip(final_fit$.workflow[[1]])
broom::tidy(final_model, conf.int = TRUE) %>% arrange(desc(abs(estimate))) %>% head(30)
```
