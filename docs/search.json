[
  {
    "objectID": "homework8.html",
    "href": "homework8.html",
    "title": "Homework 8 - Seoul Bike Rentals — MLR with tidymodels (HW)",
    "section": "",
    "text": "set.seed(2025)\nlibrary(tidyverse); library(lubridate); library(janitor); library(skimr); library(GGally)\n\nWarning: package 'tidyverse' was built under R version 4.4.3\n\n\nWarning: package 'ggplot2' was built under R version 4.4.3\n\n\nWarning: package 'tibble' was built under R version 4.4.3\n\n\nWarning: package 'tidyr' was built under R version 4.4.3\n\n\nWarning: package 'readr' was built under R version 4.4.3\n\n\nWarning: package 'purrr' was built under R version 4.4.3\n\n\nWarning: package 'dplyr' was built under R version 4.4.3\n\n\nWarning: package 'stringr' was built under R version 4.4.3\n\n\nWarning: package 'forcats' was built under R version 4.4.3\n\n\nWarning: package 'lubridate' was built under R version 4.4.3\n\n\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   4.0.0     ✔ tibble    3.2.1\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.2.0     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors\n\n\nWarning: package 'janitor' was built under R version 4.4.3\n\n\n\nAttaching package: 'janitor'\n\nThe following objects are masked from 'package:stats':\n\n    chisq.test, fisher.test\n\n\nWarning: package 'skimr' was built under R version 4.4.3\n\n\nWarning: package 'GGally' was built under R version 4.4.3\n\nlibrary(tidymodels)\n\nWarning: package 'tidymodels' was built under R version 4.4.3\n\n\n── Attaching packages ────────────────────────────────────── tidymodels 1.4.1 ──\n✔ broom        1.0.10     ✔ rsample      1.3.1 \n✔ dials        1.4.2      ✔ tailor       0.1.0 \n✔ infer        1.0.9      ✔ tune         2.0.1 \n✔ modeldata    1.5.1      ✔ workflows    1.3.0 \n✔ parsnip      1.3.3      ✔ workflowsets 1.1.1 \n✔ recipes      1.3.1      ✔ yardstick    1.3.2 \n\n\nWarning: package 'broom' was built under R version 4.4.3\n\n\nWarning: package 'dials' was built under R version 4.4.3\n\n\nWarning: package 'scales' was built under R version 4.4.3\n\n\nWarning: package 'infer' was built under R version 4.4.3\n\n\nWarning: package 'modeldata' was built under R version 4.4.3\n\n\nWarning: package 'parsnip' was built under R version 4.4.3\n\n\nWarning: package 'recipes' was built under R version 4.4.3\n\n\nWarning: package 'rsample' was built under R version 4.4.3\n\n\nWarning: package 'tailor' was built under R version 4.4.3\n\n\nWarning: package 'tune' was built under R version 4.4.3\n\n\nWarning: package 'workflows' was built under R version 4.4.3\n\n\nWarning: package 'workflowsets' was built under R version 4.4.3\n\n\nWarning: package 'yardstick' was built under R version 4.4.3\n\n\n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n\n\n\nData prep\n\nurl &lt;- \"https://www4.stat.ncsu.edu/~online/datasets/SeoulBikeData.csv\"\nraw_hourly &lt;- readr::read_csv(url, locale = readr::locale(encoding = \"Latin1\")) %&gt;% clean_names()\n\nRows: 8760 Columns: 14\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr  (4): Date, Seasons, Holiday, Functioning Day\ndbl (10): Rented Bike Count, Hour, Temperature(°C), Humidity(%), Wind speed ...\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\nhourly &lt;- raw_hourly %&gt;%\n  mutate(\n    date = dmy(date),\n    seasons = factor(seasons, levels = c(\"Winter\",\"Spring\",\"Summer\",\"Autumn\")),\n    holiday = factor(holiday),\n    functioning_day = factor(functioning_day)\n  ) %&gt;%\n  rename(\n    bike_count      = rented_bike_count,\n    temp            = temperature_c,\n    humidity        = humidity_percent,\n    windspeed       = wind_speed_m_s,\n    visibility      = visibility_10m,\n    dew_point_temp  = dew_point_temperature_c,\n    solar_radiation = solar_radiation_mj_m2,\n    rainfall        = rainfall_mm,\n    snowfall        = snowfall_cm\n  )\n\ndaily &lt;- hourly %&gt;% filter(functioning_day == \"Yes\") %&gt;%\n  group_by(date, seasons, holiday) %&gt;%\n  summarise(\n    bike_count      = sum(bike_count, na.rm = TRUE),\n    rainfall        = sum(rainfall, na.rm = TRUE),\n    snowfall        = sum(snowfall, na.rm = TRUE),\n    temp            = mean(temp, na.rm = TRUE),\n    humidity        = mean(humidity, na.rm = TRUE),\n    windspeed       = mean(windspeed, na.rm = TRUE),\n    visibility      = mean(visibility, na.rm = TRUE),\n    dew_point_temp  = mean(dew_point_temp, na.rm = TRUE),\n    solar_radiation = mean(solar_radiation, na.rm = TRUE),\n    .groups = \"drop\"\n  )\n\n\n\nSplit\n\nset.seed(2025)\nsplit_obj &lt;- initial_split(daily, prop = 0.75, strata = seasons)\ntrain &lt;- training(split_obj); test &lt;- testing(split_obj)\nset.seed(2025); cv10 &lt;- vfold_cv(train, v = 10, strata = seasons)\n\n\n\nRecipes\n\nbase_recipe &lt;- function(dat) {\n  recipe(bike_count ~ ., data = dat) %&gt;%\n    update_role(date, new_role = \"ID\") %&gt;%\n    step_date(date, features = \"dow\", label = TRUE) %&gt;%\n    step_mutate(is_weekend = as.integer(as.character(date_dow) %in% c(\"Saturday\",\"Sunday\"))) %&gt;%\n    step_rm(date_dow) %&gt;%\n    step_dummy(all_nominal_predictors(), one_hot = TRUE) %&gt;%\n    step_zv(all_predictors()) %&gt;%\n    step_normalize(all_numeric_predictors())\n}\n\nrec1 &lt;- base_recipe(train)\n\nrec2 &lt;- base_recipe(train) %&gt;%\n  step_interact(terms = ~ starts_with(\"seasons_\"):starts_with(\"holiday_\") +\n                      starts_with(\"seasons_\"):temp +\n                      temp:rainfall)\n\n# Explicitly apply poly ONLY to continuous weather vars (avoid dummy/binary columns)\nrec3 &lt;- base_recipe(train) %&gt;%\n  step_interact(terms = ~ starts_with(\"seasons_\"):starts_with(\"holiday_\") +\n                      starts_with(\"seasons_\"):temp +\n                      temp:rainfall) %&gt;%\n  step_poly(temp, humidity, windspeed, visibility, dew_point_temp, solar_radiation, rainfall, snowfall,\n            degree = 2)\n\n\n\nModel + CV\n\nlm_spec &lt;- linear_reg() %&gt;% set_engine(\"lm\")\nwf1 &lt;- workflow() %&gt;% add_model(lm_spec) %&gt;% add_recipe(rec1)\nwf2 &lt;- workflow() %&gt;% add_model(lm_spec) %&gt;% add_recipe(rec2)\nwf3 &lt;- workflow() %&gt;% add_model(lm_spec) %&gt;% add_recipe(rec3)\n\nmetrics &lt;- metric_set(rmse, rsq)\nset.seed(2025)\nres1 &lt;- fit_resamples(wf1, resamples = cv10, metrics = metrics, control = control_resamples(save_pred = TRUE))\n\n→ A | warning: prediction from rank-deficient fit; consider predict(., rankdeficient=\"NA\")\n\n\nThere were issues with some computations   A: x1\n\n\nThere were issues with some computations   A: x4\n\n\nThere were issues with some computations   A: x7\n\n\nThere were issues with some computations   A: x9\n\n\nThere were issues with some computations   A: x10\n\n\n\n\nset.seed(2025)\nres2 &lt;- fit_resamples(wf2, resamples = cv10, metrics = metrics, control = control_resamples(save_pred = TRUE))\n\n→ A | warning: prediction from rank-deficient fit; consider predict(., rankdeficient=\"NA\")\n\n\nThere were issues with some computations   A: x1\n\n\nThere were issues with some computations   A: x3\n\n\nThere were issues with some computations   A: x6\n\n\nThere were issues with some computations   A: x8\n\n\nThere were issues with some computations   A: x10\n\n\n\n\nset.seed(2025)\nres3 &lt;- fit_resamples(wf3, resamples = cv10, metrics = metrics, control = control_resamples(save_pred = TRUE))\n\n→ A | warning: prediction from rank-deficient fit; consider predict(., rankdeficient=\"NA\")\n\n\nThere were issues with some computations   A: x2\n\n\nThere were issues with some computations   A: x3\n\n\nThere were issues with some computations   A: x5\n\n\nThere were issues with some computations   A: x7\n\n\nThere were issues with some computations   A: x9\n\n\nThere were issues with some computations   A: x10\n\n\n\n\ncv_summary &lt;- bind_rows(\n  collect_metrics(res1) %&gt;% mutate(model = \"Recipe 1\"),\n  collect_metrics(res2) %&gt;% mutate(model = \"Recipe 2\"),\n  collect_metrics(res3) %&gt;% mutate(model = \"Recipe 3\")\n) %&gt;% filter(.metric == \"rmse\") %&gt;% arrange(mean)\n\ncv_summary\n\n# A tibble: 3 × 7\n  .metric .estimator  mean     n std_err .config         model   \n  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;   \n1 rmse    standard   3003.    10    243. pre0_mod0_post0 Recipe 3\n2 rmse    standard   3192.    10    239. pre0_mod0_post0 Recipe 2\n3 rmse    standard   4193.    10    217. pre0_mod0_post0 Recipe 1\n\nbest_model_name &lt;- cv_summary$model[1]\nbest_model_name\n\n[1] \"Recipe 3\"\n\n\n\n\nFinalize\n\nbest_wf &lt;- switch(best_model_name, \"Recipe 1\" = wf1, \"Recipe 2\" = wf2, \"Recipe 3\" = wf3)\nfinal_fit &lt;- last_fit(best_wf, split = split_obj, metrics = metrics)\n\n→ A | warning: prediction from rank-deficient fit; consider predict(., rankdeficient=\"NA\")\n\n\nThere were issues with some computations   A: x1\nThere were issues with some computations   A: x1\n\n\n\n\ncollect_metrics(final_fit)\n\n# A tibble: 2 × 4\n  .metric .estimator .estimate .config        \n  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;          \n1 rmse    standard    3611.    pre0_mod0_post0\n2 rsq     standard       0.874 pre0_mod0_post0\n\nfinal_model &lt;- extract_fit_parsnip(final_fit$.workflow[[1]])\nbroom::tidy(final_model, conf.int = TRUE) %&gt;% arrange(desc(abs(estimate))) %&gt;% head(30)\n\n# A tibble: 30 × 7\n   term                 estimate std.error statistic  p.value conf.low conf.high\n   &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;\n 1 dew_point_temp_poly…  218202.    81355.      2.68 7.83e- 3   57925.   378480.\n 2 temp_poly_1          -156036.    69272.     -2.25 2.52e- 2 -292509.   -19563.\n 3 humidity_poly_1       -69789.    23982.     -2.91 3.96e- 3 -117037.   -22541.\n 4 temp_poly_2           -48427.    18083.     -2.68 7.93e- 3  -84053.   -12801.\n 5 solar_radiation_pol…   44897.     5776.      7.77 2.38e-13   33518.    56276.\n 6 rainfall_poly_1       -30619.     8175.     -3.75 2.27e- 4  -46724.   -14513.\n 7 (Intercept)            19203.     1584.     12.1  1.37e-26   16082.    22324.\n 8 rainfall_poly_2        17061.     3531.      4.83 2.44e- 6   10104.    24017.\n 9 dew_point_temp_poly…   14243.    12567.      1.13 2.58e- 1  -10516.    39001.\n10 seasons_Summer          6198.      970.      6.39 8.96e-10    4286.     8109.\n# ℹ 20 more rows"
  }
]